name: Instanciate public music

on: 
    #workflow_dispatch
    schedule:
    #- cron:  '0 */6 * * *'
    - cron: '30 3,9,15,21 * * *'

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
      with:
        ssh-key: ${{ secrets.SECRET_SSH_TO_CONFIGFILES_PRIVATE_KEY }}
        repository: jackett2/configfiles
        path: ./CONFIGFILES_PRIVATE

    - name: What time is it ?
      run: |
        date -u
        TZ="Europe/Paris" date
    
    - name: Install some packages
      run: |
        set -xe
        APT='sudo apt -y -qq -o=Dpkg::Use-Pty=0'
        $APT update
        $APT install axel bmon colordiff fd-find ffmpeg htop nmon nmap ncat socat parallel python3 python3-dev python3-pip python3-virtualenv rar ripgrep virtualenvwrapper unrar
        
    - name: Populate $CONFIGFILES_PRIVATE env var
      run: echo "CONFIGFILES_PRIVATE=$GITHUB_WORKSPACE/CONFIGFILES_PRIVATE" >> $GITHUB_ENV

    - name: Tweak some config and start the services
      continue-on-error: true
      run: |
        set -xe
        mkdir /tmp/music

        echo ${{ secrets.SECRET_MUSIC_SSH_KEY_PRIVATE }} > /tmp/key
        chmod 400 /tmp/key
        
        cp -f -r $CONFIGFILES_PRIVATE/music/ /tmp/music/
        cd /tmp/music/
        docker-compose up -d
        
    - name: Start tunnel
      env:
        SECRET_MUSIC_PIPED_FE: ${{ secrets.SECRET_MUSIC_PIPED_FE }}
        SECRET_MUSIC_PIPED_BE: ${{ secrets.SECRET_MUSIC_PIPED_BE }}
        SECRET_MUSIC_PIPED_PROXY: ${{ secrets.SECRET_MUSIC_PIPED_PROXY }}
        SECRET_MUSIC_HYP_FE: ${{ secrets.SECRET_MUSIC_HYP_FE }}
        SECRET_MUSIC_HYP_BE: ${{ secrets.SECRET_MUSIC_HYP_BE }}
        SECRET_SSH_RUNNER_GW: ${{ secrets.SECRET_SSH_RUNNER_GW }}
        
      run: |
        timeout 350m ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -i /tmp/key -R "$SECRET_MUSIC_PIPED_FE":80:localhost:8080 -R "$SECRET_MUSIC_PIPED_BE":80:localhost:8080 -R "$SECRET_MUSIC_PIPED_PROXY":80:localhost:8080 -R "$SECRET_MUSIC_HYP_FE":80:localhost:8081 -R "$SECRET_MUSIC_HYP_BE":80:localhost:3000 "$secrets.SECRET_SSH_RUNNER_GW"
